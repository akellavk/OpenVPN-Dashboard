<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>OpenVPN Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .card { box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="container mt-5">
<h1 class="text-center mb-4">OpenVPN Management Dashboard</h1>

<div class="text-end mb-3">
    <button id="logoutBtn" class="btn btn-outline-danger">Выход</button>
</div>

<!-- Вкладки -->
<ul class="nav nav-tabs" id="myTab" role="tablist">
    <li class="nav-item">
        <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button">
            Пользователи
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button">История
            подключений
        </button>
    </li>
</ul>

<div class="tab-content mt-3">
    <!-- Вкладка Пользователи -->
    <div class="tab-pane fade show active" id="users" role="tabpanel">
        <!-- Подключенные клиенты -->
        <div class="card mb-4">
            <div class="card-body">
                <h5>Подключенные клиенты: {{ status.clients }}</h5>
                <table class="table table-striped">
                    <thead>
                    <tr>
                        <th>Имя</th>
                        <th>IP</th>
                        <th>Получено (МБ)</th>
                        <th>Отправлено (МБ)</th>
                        <th>Подключен с</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for client in status.stats %}
                        <tr>
                            <td>{{ client.common_name }}</td>
                            <td>{{ client.real_address }}</td>
                            <td>{{ client.bytes_received }}</td>
                            <td>{{ client.bytes_sent }}</td>
                            <td>{{ client.connected_since }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Управление пользователями -->
        <div class="card mb-4">
            <div class="card-body">
                <h5>Управление пользователями</h5>
                <form id="addUserForm" action="/add_user" method="post" class="mb-3">
                    <div class="mb-3">
                        <input type="text" name="username" class="form-control d-inline-block w-50"
                               placeholder="Имя пользователя" required>
                    </div>
                    <div class="mb-3">
                        <input type="email" name="email" class="form-control d-inline-block w-50"
                               placeholder="Email (опционально)">
                    </div>
                    <div class="mb-3">
                        <input type="text" name="description" class="form-control d-inline-block w-50"
                               placeholder="Описание (опционально)">
                    </div>
                    <button type="submit" class="btn btn-primary">Добавить</button>
                </form>
                <form id="revokeUserForm" action="/revoke_user" method="post">
                    <input type="text" name="username" class="form-control d-inline-block w-50"
                           placeholder="Имя пользователя" required>
                    <button type="submit" class="btn btn-danger">Удалить</button>
                </form>
            </div>
        </div>

        <!-- Блок уведомлений -->
        <div id="alert-container" class="mt-3"></div>

        <!-- Все пользователи -->
        <div class="card mb-4">
            <div class="card-body">
                <h5>Все пользователи</h5>
                <table class="table table-striped">
                    <thead>
                    <tr>
                        <th>Имя</th>
                        <th>Email</th>
                        <th>Описание</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for user in all_users %}
                        <tr>
                            <td>{{ user.common_name }}</td>
                            <td>{{ user.email or "Не указан" }}</td>
                            <td>{{ user.description or "Не указано" }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- График трафика -->
        <div class="card">
            <div class="card-body">
                <h5>Статистика (график трафика)</h5>
                <canvas id="trafficChart" height="200"></canvas>
                <script>
                    var ctx = document.getElementById('trafficChart').getContext('2d');
                    var chart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: [{% for client in status.stats %}'{{ client.common_name }}', {% endfor %}],
                                datasets: [{
                                    label: 'Получено (МБ)',
                                    data: [{% for client in status.stats %}{{ client.bytes_received }}, {% endfor %}],
                                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                    borderColor: 'rgba(75, 192, 192, 1)'
                                }, {
                                    label: 'Отправлено (МБ)',
                                    data: [{% for client in status.stats %}{{ client.bytes_sent }}, {% endfor %}],
                                    backgroundColor: 'rgba(153, 102, 255, 0.2)',
                                    borderColor: 'rgba(153, 102, 255, 1)'
                                }]
                            },
                            options: { scales: { y: { beginAtZero: true } } }
                        });
                </script>
            </div>
        </div>
    </div>

    <!-- Вкладка История подключений -->
    <div class="tab-pane fade" id="history" role="tabpanel">
        <div class="card">
            <div class="card-body">
                <h5>История подключений</h5>
                <table class="table table-striped">
                    <thead>
                    <tr>
                        <th>Пользователь</th>
                        <th>Подключён</th>
                        <th>Отключён</th>
                        <th>Длительность (мин)</th>
                        <th>Получено (МБ)</th>
                        <th>Отправлено (МБ)</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for c in connections %}
                        <tr>
                            <td>{{ c.common_name }}</td>
                            <td>{{ c.connected_at }}</td>
                            <td>{{ c.disconnected_at or "Активен" }}</td>
                            <td>{{ c.duration_minutes or "-" }}</td>
                            <td>{{ c.bytes_received }}</td>
                            <td>{{ c.bytes_sent }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Обработка выхода
    document.getElementById('logoutBtn').addEventListener('click', () => {
        fetch('/logout', { method: 'GET' })
            .then(() => window.location.href = '/login');
    });
    function showAlert(message, type="success") {
        const alertContainer = document.getElementById("alert-container");
        alertContainer.innerHTML = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert" id="auto-hide-alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
        setTimeout(() => {
            const alert = document.getElementById("auto-hide-alert");
            if (alert) {
                const bsAlert = bootstrap.Alert.getOrCreateInstance(alert);
                bsAlert.close();
            }
        }, 3000);
    }

    async function handleFormSubmit(event, url) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);

        const response = await fetch(url, { method: "POST", headers: {
                'Authorization': 'Bearer supermario' },  body: formData });
        const result = await response.json();

        if (result.message) {
            showAlert(result.message, "success");
            form.reset();
            setTimeout(() => location.reload(), 8000);
        } else {
            showAlert(result.error || "Ошибка выполнения", "danger");
        }
    }

    document.getElementById("addUserForm").addEventListener("submit", e => handleFormSubmit(e, "/add_user"));
    document.getElementById("revokeUserForm").addEventListener("submit", e => handleFormSubmit(e, "/revoke_user"));
</script>
<script>
    // Автообновление данных каждые 30 секунд
    setInterval(() => {
        if (document.getElementById('history-tab').classList.contains('active')) {
            fetch('/')
                .then(response => response.text())
                .then(data => {
                    const parser = new DOMParser();
                    const newDoc = parser.parseFromString(data, 'text/html');
                    const newTable = newDoc.querySelector('#history table');
                    document.querySelector('#history table').replaceWith(newTable);
                });
        }
    }, 30000);
</script>
</body>
</html>
