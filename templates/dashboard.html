<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>OpenVPN Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
        }

        .card {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body class="container mt-5">
    <h1 class="text-center mb-4">OpenVPN Management Dashboard</h1>

    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã -->
    <div class="card mb-4">
        <div class="card-body">
            <h5>–ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã: {{ status.clients }}</h5>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>–ò–º—è</th>
                        <th>IP</th>
                        <th>–ü–æ–ª—É—á–µ–Ω–æ (–ú–ë)</th>
                        <th>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ (–ú–ë)</th>
                        <th>–ü–æ–¥–∫–ª—é—á–µ–Ω —Å</th>
                    </tr>
                </thead>
                <tbody>
                    {% for client in status.stats %}
                    <tr>
                        <td>{{ client.common_name }}</td>
                        <td>{{ client.real_address }}</td>
                        <td>{{ client.bytes_received }}</td>
                        <td>{{ client.bytes_sent }}</td>
                        <td>{{ client.connected_since }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ -->
    <div class="card mb-4">
        <div class="card-body">
            <h5>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h5>
            <form id="addUserForm" action="/add_user" method="post" class="mb-3">
                <div class="mb-3">
                    <input type="text" name="username" class="form-control d-inline-block w-50"
                        placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" required>
                </div>
                <div class="mb-3">
                    <input type="email" name="email" class="form-control d-inline-block w-50"
                        placeholder="Email (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
                </div>
                <div class="mb-3">
                    <input type="text" name="description" class="form-control d-inline-block w-50"
                        placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
                </div>
                <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
            </form>
            <form id="revokeUserForm" action="/revoke_user" method="post">
                <input type="text" name="username" class="form-control d-inline-block w-50"
                    placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" required>
                <button type="submit" class="btn btn-danger">–£–¥–∞–ª–∏—Ç—å</button>
            </form>
        </div>
    </div>

    <!-- –ë–ª–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
    <div id="alert-container" class="mt-3"></div>

    <!-- –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
    <div class="card mb-4">
        <div class="card-body">
            <h5>–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h5>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>–ò–º—è</th>
                        <th>Email</th>
                        <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in all_users %}
                    <tr>
                        <td>{{ user.common_name }}</td>
                        <td>{{ user.email or "–ù–µ —É–∫–∞–∑–∞–Ω" }}</td>
                        <td>{{ user.description or "–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- –ì—Ä–∞—Ñ–∏–∫ —Ç—Ä–∞—Ñ–∏–∫–∞ -->
    <div class="card">
        <div class="card-body">
            <h5>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–≥—Ä–∞—Ñ–∏–∫ —Ç—Ä–∞—Ñ–∏–∫–∞)</h5>
            <canvas id="trafficChart" height="200"></canvas>
            <script>
                var ctx = document.getElementById('trafficChart').getContext('2d');
                var chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: [{% for client in status.stats %}'{{ client.common_name }}', {% endfor %}],
                datasets: [{
                    label: '–ü–æ–ª—É—á–µ–Ω–æ (–ú–ë)',
                    data: [{% for client in status.stats %}{{ client.bytes_received }}, {% endfor %}],
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)'
                        }, {
                    label: '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ (–ú–ë)',
                        data: [{% for client in status.stats %} { { client.bytes_sent } }, {% endfor %}],
                backgroundColor: 'rgba(153, 102, 255, 0.2)',
                    borderColor: 'rgba(153, 102, 255, 1)'
                        }]
                    },
                options: { scales: { y: { beginAtZero: true } } }
                });
            </script>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function showAlert(message, type = "success") {
            const alertContainer = document.getElementById("alert-container");
            alertContainer.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert" id="auto-hide-alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                const alert = document.getElementById("auto-hide-alert");
                if (alert) {
                    const bsAlert = bootstrap.Alert.getOrCreateInstance(alert);
                    bsAlert.close();
                }
            }, 3000);
        }

        async function handleFormSubmit(event, url) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            const response = await fetch(url, {
                method: "POST",
                body: formData
            });

            const result = await response.json();
            if (result.message) {
                showAlert(result.message, "success");
                form.reset();

                // üîÑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–º —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏–ª—Å—è —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                setTimeout(() => location.reload(), 3000);
            } else {
                showAlert(result.error || "–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è", "danger");
            }
        }

        document.getElementById("addUserForm").addEventListener("submit", e => handleFormSubmit(e, "/add_user"));
        document.getElementById("revokeUserForm").addEventListener("submit", e => handleFormSubmit(e, "/revoke_user"));
    </script>
</body>

</html>